<?xml version="1.0" encoding="UTF-8"?>
<project default="all" name="TEI-Publisher">
    <property file="local.build.properties"/>
    <xmlproperty file="build.properties.xml" semanticAttributes="true" keepRoot="false"/>
    <property name="project.app" value="tei-publisher"/>
    <property name="project.version" value="5.0.2"/>
    <property name="server.url" value="http://demo.exist-db.org/exist/apps/public-repo/public/"/>
    <property name="build" value="build"/>
    <property name="bundle.dir" value="build/bundle"/>


    <condition property="git.commit" value="${git.commit}" else="">
        <isset property="git.commit"/>
    </condition>

    <target name="all" depends="xar"/>

    <target name="rebuild" depends="clean,all"/>

    <target name="clean" depends="npm.clean">
        <delete dir="${build}"/>
        <delete dir="resources/scripts" includes="*.js *.map"/>
        <delete dir="resources/images" includes="leaflet/** openseadragon/**"/>
        <delete dir="resources/css/vendor" includes="leaflet.css"/>
    </target>

    <target name="xar" depends="clean, npm.build">
        <mkdir dir="${build}"/>
        <zip destfile="${build}/${project.app}-${project.version}${git.commit}.xar">
            <fileset dir=".">
                <exclude name="${build}/*"/>
                <exclude name=".git*"/>
                <exclude name="*.tmpl"/>
                <exclude name="*.properties"/>
                <exclude name="webtest/**"/>
                <exclude name="cache/**"/>
                <exclude name=".idea/"/>
                <exclude name=".vscode/**"/>
                <exclude name="package*.json"/>
                <exclude name="rollup.config.js"/>
                <exclude name=".existdb.json"/>
                <exclude name=".editorconfig"/>
                <exclude name="node_modules/**"/>
                <exclude name="components/"/>
            </fileset>
        </zip>
    </target>

    <target name="npm.build">
        <exec executable="${npm}" outputproperty="npm.output">
            <arg line="run-script"/>
            <arg line="build:production"/>
        </exec>
        <echo message="${npm.output}"/>
    </target>
    
    <target name="npm.clean">
        <exec executable="${npm}" outputproperty="npm.output">
            <arg line="run-script"/>
            <arg line="clean"/>
        </exec>
        <echo message="${npm.output}"/>
    </target>
    
    <target name="upload">
        <input message="Enter password:" addproperty="server.pass" defaultvalue="">
            <handler type="secure"/>
        </input>
        <property name="xar" value="${project.app}-${project.version}${git.commit}.xar"/>
        <exec executable="curl">
            <arg line="-T ${build}/${xar} -u admin:${server.pass} ${server.url}/${xar}"/>
        </exec>
    </target>

</project>
